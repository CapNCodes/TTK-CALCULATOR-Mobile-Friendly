
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Advanced TTK Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 12px;
    }

    h1, h2, h3 {
      margin-top: 0;
      color: #f9fafb;
      font-weight: 600;
    }

    .box {
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 18px;
      background: #020617;
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }

    input, select, button {
      font-size: 15px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      width: 100%;
      box-sizing: border-box;
    }

    input:focus, select:focus {
      outline: 2px solid #38bdf8;
    }

    button {
      cursor: pointer;
      background: #0ea5e9;
      border: none;
      color: #0b1120;
      font-weight: 600;
      border-radius: 6px;
      padding: 10px 12px;
      width: auto;
    }

    button.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .row > div {
      flex: 1 1 140px;
      min-width: 140px;
    }

    .range-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .range-row input {
      width: 100px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 12px;
      overflow-x: auto;
      display: block;
    }

    th, td {
      border: 1px solid #1f2937;
      padding: 8px 6px;
      text-align: center;
      white-space: nowrap;
    }

    th {
      background: #020617;
    }

    .small-note {
      font-size: 12px;
      color: #9ca3af;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .table-wrapper {
      overflow-x: auto;
      width: 100%;
    }

    @media (max-width: 600px) {
      h1 { font-size: 22px; }
      h2 { font-size: 18px; }
      h3 { font-size: 16px; }

      button {
        padding: 12px;
        font-size: 16px;
      }

      input, select {
        font-size: 16px;
        padding: 12px;
      }

      .range-row input {
        width: 80px;
      }
    }
  </style>
</head>
<body>
  <h1>Advanced TTK Calculator</h1>

  <!-- Gun settings -->
  <div class="box">
    <h2>Gun Settings</h2>

    <div class="row">
      <div>
        <label>Gun name</label>
        <input id="gunName" type="text" placeholder="e.g. Type 25">
      </div>
      <div>
        <label>Fire interval (ms)</label>
        <input id="fireInterval" type="number" step="1" value="80">
      </div>
    </div>

    <h3>Damage multipliers</h3>
    <div class="row">
      <div><label>Head</label><input id="multHead" type="number" step="0.01" value="1.3"></div>
      <div><label>Upper body</label><input id="multUpper" type="number" step="0.01" value="1.1"></div>
      <div><label>Lower body</label><input id="multLower" type="number" step="0.01" value="1.0"></div>
      <div><label>Upper arm</label><input id="multUArm" type="number" step="0.01" value="1.0"></div>
      <div><label>Lower arm</label><input id="multLArm" type="number" step="0.01" value="1.0"></div>
      <div><label>Legs</label><input id="multLegs" type="number" step="0.01" value="1.0"></div>
    </div>

    <h3>Damage ranges</h3>
    <div id="ranges"></div>
    <button type="button" onclick="addRange()">Add range</button>
    <div class="small-note">Ranges are checked in the order you enter them.</div>

    <h3>Final damage breakdown</h3>
    <button type="button" class="secondary" onclick="refreshBreakdown()">Refresh breakdown</button>
    <div id="breakdown"></div>

    <h3>Saved guns</h3>
    <div class="row">
      <div>
        <label>Select gun</label>
        <select id="gunSelect" onchange="loadSelectedGun()"></select>
      </div>
      <div style="display:flex; gap:6px; align-items:flex-end; flex-wrap:wrap;">
        <button onclick="saveCurrentGun()">Save / Update</button>
        <button class="secondary" onclick="deleteCurrentGun()">Delete</button>
        <button class="secondary" onclick="clearGunForm()">Clear stats</button>
      </div>
    </div>
  </div>

  <!-- Comparison settings -->
  <div class="box">
    <h2>Comparison Settings</h2>
    <div class="toggle-row">
      <label>Enable comparison</label>
      <select id="compareToggle">
        <option value="off">Off</option>
        <option value="on">On</option>
      </select>
    </div>
    <div class="row">
      <div>
        <label>Compare with gun</label>
        <select id="compareSelect"></select>
      </div>
      <div style="display:flex; align-items:flex-end;">
        <button class="secondary" onclick="swapGuns()">Swap Gun A ↔ Gun B</button>
      </div>
    </div>
    <div class="small-note">Comparison uses the same shot pattern and HP settings.</div>
  </div>

  <!-- HP settings -->
  <div class="box">
    <h2>HP Settings</h2>
    <div class="row">
      <div>
        <label>Preset HP values</label>
        <input id="hpPresets" type="text" value="100,150,200,250,300">
      </div>
      <div>
        <label>Extra custom HP</label>
        <input id="hpCustom" type="number" min="1" placeholder="e.g. 220">
      </div>
    </div>
  </div>

  <!-- Shot pattern -->
  <div class="box">
    <h2>Shot Pattern</h2>
    <label>Pattern</label>
    <select id="pattern" onchange="onPatternChange()">
      <option value="all_head">All Head</option>
      <option value="all_upper">All Upper Body</option>
      <option value="all_lower">All Lower Body</option>
      <option value="all_legs">All Legs</option>
      <option value="one_head_rest_upper">1 Head, rest Upper Body</option>
      <option value="two_head_rest_upper">2 Head, rest Upper Body</option>
      <option value="one_head_one_uarm_rest_upper">1 Head + 1 Upper Arm + rest Upper Body</option>
      <option value="custom">Custom</option>
    </select>

    <div id="customPattern" style="display:none; margin-top:8px;">
      <div class="row">
        <div><label>Head</label><input id="c_head" type="number" min="0" value="0"></div>
        <div><label>Upper</label><input id="c_upper" type="number" min="0" value="0"></div>
        <div><label>Lower</label><input id="c_lower" type="number" min="0" value="0"></div>
        <div><label>U‑Arm</label><input id="c_uarm" type="number" min="0" value="0"></div>
        <div><label>L‑Arm</label><input id="c_larm" type="number" min="0" value="0"></div>
        <div><label>Legs</label><input id="c_legs" type="number" min="0" value="0"></div>
      </div>
      <div class="small-note">If pattern doesn't kill, extra upper-body shots are added.</div>
    </div>
  </div>

  <!-- Results -->
  <div class="box">
    <h2>Results</h2>

<label>Range to calculate:</label>
<select id="rangeSelect">
  <option value="all">All ranges</option>
</select>

<button onclick="calculateAll()">Calculate</button>
<div id="results"></div>
  </div>

<script>
/* ------------------------------
   STORAGE
------------------------------ */
let guns = [];
let currentGunIndex = -1;

function loadGunsFromStorage() {
  const raw = localStorage.getItem("ttk_guns");
  guns = raw ? JSON.parse(raw) : [];
  refreshGunSelects();
}

function saveGunsToStorage() {
  localStorage.setItem("ttk_guns", JSON.stringify(guns));
}
/* ------------------------------
   GUN FORM
------------------------------ */
function refreshGunSelects() {
  const mainSel = document.getElementById("gunSelect");
  const cmpSel = document.getElementById("compareSelect");
  mainSel.innerHTML = "";
  cmpSel.innerHTML = "";

  if (guns.length === 0) {
    mainSel.innerHTML = `<option value="-1">(no saved guns)</option>`;
    cmpSel.innerHTML = `<option value="-1">(no guns)</option>`;
    currentGunIndex = -1;
    return;
  }

  guns.forEach((g, i) => {
    mainSel.innerHTML += `<option value="${i}">${g.name}</option>`;
    cmpSel.innerHTML += `<option value="${i}">${g.name}</option>`;
  });

  if (currentGunIndex < 0 || currentGunIndex >= guns.length) currentGunIndex = 0;
  mainSel.value = currentGunIndex;

  let cmpIndex = currentGunIndex + 1 < guns.length ? currentGunIndex + 1 : 0;
  cmpSel.value = cmpIndex;

  loadGunToForm(guns[currentGunIndex]);
}
  
function refreshRangeSelect(gun) {
  const sel = document.getElementById("rangeSelect");
  sel.innerHTML = `<option value="all">All ranges</option>`;

  gun.ranges.forEach((r, i) => {
    const prevMax = i === 0 ? 0 : gun.ranges[i - 1].max;
    const prefix = `R${i + 1} (${prevMax}–${r.max}m, ${r.damage} dmg)`;
    sel.innerHTML += `<option value="${i}">${prefix}</option>`;
  });
}

function loadSelectedGun() {
  const idx = parseInt(document.getElementById("gunSelect").value);
  if (!isNaN(idx) && idx >= 0 && idx < guns.length) {
    currentGunIndex = idx;
    loadGunToForm(guns[idx]);
  }
}

function loadGunToForm(gun) {
  document.getElementById("gunName").value = gun.name;
  document.getElementById("fireInterval").value = gun.fireInterval;

  document.getElementById("multHead").value = gun.multipliers.head;
  document.getElementById("multUpper").value = gun.multipliers.upper;
  document.getElementById("multLower").value = gun.multipliers.lower;
  document.getElementById("multUArm").value = gun.multipliers.uarm;
  document.getElementById("multLArm").value = gun.multipliers.larm;
  document.getElementById("multLegs").value = gun.multipliers.legs;

  const rangesDiv = document.getElementById("ranges");
  rangesDiv.innerHTML = "";
  gun.ranges.forEach(r => addRangeRow(r.max, r.damage));

  refreshBreakdown();
  refreshRangeSelect(gun);
}

function readGunFromForm() {
  const name = document.getElementById("gunName").value.trim();
  const fireInterval = parseFloat(document.getElementById("fireInterval").value) || 80;

  const multHead = parseFloat(document.getElementById("multHead").value) || 1.0;
  const multUpper = parseFloat(document.getElementById("multUpper").value) || 1.0;
  const multLower = parseFloat(document.getElementById("multLower").value) || 1.0;
  const multUArm = parseFloat(document.getElementById("multUArm").value) || 1.0;
  const multLArm = parseFloat(document.getElementById("multLArm").value) || 1.0;
  const multLegs = parseFloat(document.getElementById("multLegs").value) || 1.0;

  const ranges = [];
  document.querySelectorAll(".range-row").forEach(row => {
    const max = parseFloat(row.querySelector(".range-max").value);
    const dmg = parseFloat(row.querySelector(".range-dmg").value);
    if (!isNaN(max) && !isNaN(dmg)) ranges.push({ max, damage: dmg });
  });

  return {
    name,
    fireInterval, // stays in ms
    multipliers: {
      head: multHead,
      upper: multUpper,
      lower: multLower,
      uarm: multUArm,
      larm: multLArm,
      legs: multLegs
    },
    ranges
  };
}

function saveCurrentGun() {
  const gun = readGunFromForm();
  if (!gun.name) return alert("Enter a gun name.");
  if (gun.ranges.length === 0) return alert("Add at least one range.");

  if (currentGunIndex >= 0 && currentGunIndex < guns.length) {
    const existing = guns[currentGunIndex];
    if (existing.name === gun.name) {
      if (!confirm(`Overwrite "${gun.name}"?`)) {
        guns.push(gun);
        currentGunIndex = guns.length - 1;
      } else {
        guns[currentGunIndex] = gun;
      }
    } else {
      guns.push(gun);
      currentGunIndex = guns.length - 1;
    }
  } else {
    guns.push(gun);
    currentGunIndex = guns.length - 1;
  }

  saveGunsToStorage();
  refreshGunSelects();
  alert("Gun saved.");
  refreshRangeSelect(gun);
}

function deleteCurrentGun() {
  if (currentGunIndex < 0) return;
  if (!confirm("Delete this gun?")) return;
  guns.splice(currentGunIndex, 1);
  saveGunsToStorage();
  currentGunIndex = -1;
  refreshGunSelects();
  document.getElementById("ranges").innerHTML = "";
  document.getElementById("breakdown").innerHTML = "";
}

function clearGunForm() {
  document.getElementById("gunName").value = "";
  document.getElementById("fireInterval").value = "80";
  document.getElementById("multHead").value = "1.3";
  document.getElementById("multUpper").value = "1.1";
  document.getElementById("multLower").value = "1.0";
  document.getElementById("multUArm").value = "1.0";
  document.getElementById("multLArm").value = "1.0";
  document.getElementById("multLegs").value = "1.0";
  document.getElementById("ranges").innerHTML = "";
  addRangeRow();
  document.getElementById("breakdown").innerHTML = "";
  
  refreshRangeSelect(readGunFromForm());
}

/* ------------------------------
   RANGE ROWS
------------------------------ */
function addRangeRow(maxVal = "", dmgVal = "") {
  const row = document.createElement("div");
  row.className = "range-row";
  row.innerHTML = `
    <label>Max (m): <input type="number" class="range-max" value="${maxVal}"></label>
    <label>Dmg: <input type="number" class="range-dmg" value="${dmgVal}"></label>
    <button class="secondary" onclick="this.parentElement.remove()">X</button>
  `;
  document.getElementById("ranges").appendChild(row);
}

/* ------------------------------
   BREAKDOWN TABLE
------------------------------ */
function refreshBreakdown() {
  const gun = readGunFromForm();
  const div = document.getElementById("breakdown");
  div.innerHTML = "";

  if (gun.ranges.length === 0) {
    div.innerHTML = `<div class="small-note">Add ranges to see breakdown.</div>`;
    return;
  }

  let html = `
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Range Max</th>
          <th>Base</th>
          <th>Head</th>
          <th>Upper</th>
          <th>Lower</th>
          <th>U-Arm</th>
          <th>L-Arm</th>
          <th>Legs</th>
        </tr>
      </thead>
      <tbody>
  `;

  gun.ranges.forEach(r => {
    html += `
      <tr>
        <td>${r.max}</td>
        <td>${r.damage}</td>
        <td>${(r.damage * gun.multipliers.head).toFixed(1)}</td>
        <td>${(r.damage * gun.multipliers.upper).toFixed(1)}</td>
        <td>${(r.damage * gun.multipliers.lower).toFixed(1)}</td>
        <td>${(r.damage * gun.multipliers.uarm).toFixed(1)}</td>
        <td>${(r.damage * gun.multipliers.larm).toFixed(1)}</td>
        <td>${(r.damage * gun.multipliers.legs).toFixed(1)}</td>
      </tr>
    `;
  });

  html += `</tbody></table></div>`;
  div.innerHTML = html;
}

/* ------------------------------
   PATTERN HANDLING
------------------------------ */
function onPatternChange() {
  const p = document.getElementById("pattern").value;
  document.getElementById("customPattern").style.display =
    p === "custom" ? "block" : "none";
}

function getPatternCounts() {
  const p = document.getElementById("pattern").value;

  switch (p) {
    case "all_head": return { head: Infinity };
    case "all_upper": return { upper: Infinity };
    case "all_lower": return { lower: Infinity };
    case "all_legs": return { legs: Infinity };
    case "one_head_rest_upper": return { head: 1, upper: Infinity };
    case "two_head_rest_upper": return { head: 2, upper: Infinity };
    case "one_head_one_uarm_rest_upper": return { head: 1, uarm: 1, upper: Infinity };
    case "custom":
      return {
        head: parseInt(document.getElementById("c_head").value) || 0,
        upper: parseInt(document.getElementById("c_upper").value) || 0,
        lower: parseInt(document.getElementById("c_lower").value) || 0,
        uarm: parseInt(document.getElementById("c_uarm").value) || 0,
        larm: parseInt(document.getElementById("c_larm").value) || 0,
        legs: parseInt(document.getElementById("c_legs").value) || 0
      };
  }
}

/* ------------------------------
   CORE DAMAGE + TTK CALC
------------------------------ */
function computeForRangeAndHP(gun, range, hp, pattern) {
  const base = range.damage;
  const m = gun.multipliers;

  let remaining = hp;
  let shots = 0;

  function applyShots(count, dmg) {
    let used = 0;
    while (remaining > 0 && used < count) {
      remaining -= dmg;
      used++;
      shots++;
    }
  }

  if (pattern.head) applyShots(pattern.head, base * m.head);
  if (remaining > 0 && pattern.upper) applyShots(pattern.upper, base * m.upper);
  if (remaining > 0 && pattern.lower) applyShots(pattern.lower, base * m.lower);
  if (remaining > 0 && pattern.uarm) applyShots(pattern.uarm, base * m.uarm);
  if (remaining > 0 && pattern.larm) applyShots(pattern.larm, base * m.larm);
  if (remaining > 0 && pattern.legs) applyShots(pattern.legs, base * m.legs);

  while (remaining > 0) {
    remaining -= base * m.upper;
    shots++;
  }

  const ttkMs = (shots - 1) * gun.fireInterval;

  return {
    shots,
    ttkMs
  };
}

/* ------------------------------
   RESULTS TABLE
------------------------------ */
function buildResultsTableForGun(gun, hpList, pattern, titleText) {
  let html = `<h3>${titleText}: ${gun.name}</h3>`;
  html += `<div class="table-wrapper"><table><thead><tr>
    <th>Range</th>
    <th>Base Damage</th>
    <th>HP</th>
    <th>Shots</th>
    <th>TTK (ms)</th>
  </tr></thead><tbody>`;

  gun.ranges.forEach((range, i) => {
    const prevMax = i === 0 ? 0 : gun.ranges[i - 1].max;
    const prefix = `R${i + 1} (${prevMax}–${range.max}m)`;

    hpList.forEach(hp => {
      const res = computeForRangeAndHP(gun, range, hp, pattern);

      html += `
        <tr>
          <td>${prefix}</td>
          <td>${range.damage}</td>
          <td>${hp}</td>
          <td>${res.shots}</td>
          <td>${Math.round(res.ttkMs)}</td>
        </tr>
      `;
    });
  });

  html += `</tbody></table></div>`;
  return html;
}
  
function buildCombinedComparisonTable(gunA, gunB, hpList, pattern, selectedRange) {
  let html = `
  <h3>Comparison: Gun A vs Gun B</h3>
  <div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Range</th>
        <th>Base Dmg</th>
        <th>HP</th>
        <th>A Shots</th>
        <th>A TTK (ms)</th>
        <th>B Shots</th>
        <th>B TTK (ms)</th>
        <th>Winner</th>
      </tr>
    </thead>
    <tbody>
  `;

  const maxRanges = Math.max(gunA.ranges.length, gunB.ranges.length);

  for (let i = 0; i < maxRanges; i++) {
    if (selectedRange !== "all" && parseInt(selectedRange) !== i) continue;

    const rangeA = gunA.ranges[i] || gunA.ranges[gunA.ranges.length - 1];
    const rangeB = gunB.ranges[i] || gunB.ranges[gunB.ranges.length - 1];

    const prevA = i === 0 ? 0 : gunA.ranges[i - 1].max;
    const prefix = `R${i + 1} (${prevA}–${rangeA.max}m, ${rangeA.damage} dmg)`;

    hpList.forEach(hp => {
      const resA = computeForRangeAndHP(gunA, rangeA, hp, pattern);
      const resB = computeForRangeAndHP(gunB, rangeB, hp, pattern);

      let winner = "Tie";
      if (resA.ttkMs < resB.ttkMs) winner = "A";
      else if (resB.ttkMs < resA.ttkMs) winner = "B";

      html += `
        <tr>
          <td>${prefix}</td>
          <td>${rangeA.damage}</td>
          <td>${hp}</td>
          <td>${resA.shots}</td>
          <td>${Math.round(resB.ttkMs)}</td>
          <td>${winner}</td>
        </tr>
      `;
    });
  }

  html += `</tbody></table></div>`;
  return html;
}

/* ------------------------------
   MAIN CALCULATION
------------------------------ */
function calculateAll() {
  const gunA = readGunFromForm();
  const hpPresets = document.getElementById("hpPresets").value
    .split(",")
    .map(x => parseInt(x.trim()))
    .filter(x => !isNaN(x));

  const customHP = parseInt(document.getElementById("hpCustom").value);
  if (!isNaN(customHP)) hpPresets.push(customHP);

  const pattern = getPatternCounts();

  let html = buildResultsTableForGun(gunA, hpPresets, pattern, "Gun A");

  if (document.getElementById("compareToggle").value === "on") {
  const idx = parseInt(document.getElementById("compareSelect").value);
  if (!isNaN(idx) && idx >= 0 && idx < guns.length) {
    const gunB = guns[idx];
    const selectedRange = document.getElementById("rangeSelect").value;
    html += buildCombinedComparisonTable(gunA, gunB, hpPresets, pattern, selectedRange);
  }
}

  const resultsDiv = document.getElementById("results");
resultsDiv.innerHTML = "";
resultsDiv.insertAdjacentHTML("beforeend", html);
}

/* ------------------------------
   SWAP GUNS
------------------------------ */
function swapGuns() {
  const mainSel = document.getElementById("gunSelect");
  const cmpSel = document.getElementById("compareSelect");

  const temp = mainSel.value;
  mainSel.value = cmpSel.value;
  cmpSel.value = temp;

  loadSelectedGun();
}

loadGunsFromStorage();
addRangeRow();
</script>
</body>
</html>
